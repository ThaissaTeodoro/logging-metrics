- uses: actions/checkout@v4

- uses: actions/setup-python@v5
  with:
    python-version: "3.11"
    cache: pip

- name: Run full CI pipeline (lint + tests + coverage)
  run: make test-ci

- name: Enforce coverage threshold (min 85%)
  run: |
    python - <<'PY'
    import sys, xml.etree.ElementTree as ET
    cov = float(ET.parse('coverage.xml').getroot().attrib['line-rate']) * 100
    thr = 85.0
    print(f"Coverage: {cov:.1f}% (min {thr}%)")
    sys.exit(0 if cov >= thr else 1)
    PY

- name: Upload coverage HTML
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: coverage-html
    path: htmlcov

- name: Upload coverage to Codecov
  uses: codecov/codecov-action@v4
  with:
    files: ./coverage.xml
    fail_ci_if_error: true
    token: ${{ secrets.CODECOV_API_TOKEN }}
